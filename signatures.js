let signaturePad;function initSignature(){signaturePad=new SignaturePad(document.getElementById('signatureCanvas'),{backgroundColor:'#fff'})}function clearSignature(){if(signaturePad)signaturePad.clear()}function loadCustomerPackages(){const n=document.getElementById('customerSigName').value.trim(),c=getCustomers().find(x=>x.name.toLowerCase().includes(n.toLowerCase()));if(!c)return alert('Not found');document.getElementById('customerPackages').innerHTML=getPackages().filter(p=>p.customerId===c.id&&p.status==='Available for Pickup').map(p=>'<div class="package-card"><input type="checkbox" data-id="'+p.id+'"> '+p.trackingNumber+' ('+p.courier+')</div>').join('');document.getElementById('signatureSection').classList.remove('hidden');if(!signaturePad)initSignature()}async function saveSignatures(){const cbs=document.querySelectorAll('#customerPackages input:checked');if(!cbs.length)return alert('Select packages');if(!signaturePad||signaturePad.isEmpty())return alert('Need signature');const sig=signaturePad.toDataURL(),photoFile=document.getElementById('photoInput').files[0];let photo=null;if(photoFile){const reader=new FileReader();photo=await new Promise(resolve=>{reader.onload=e=>resolve(e.target.result);reader.readAsDataURL(photoFile)})}let ps=getPackages();cbs.forEach(cb=>{const pkg=ps.find(p=>p.id==cb.dataset.id);if(pkg){pkg.status='Picked Up';pkg.signature=sig;if(photo)pkg.photo=photo}});savePackages(ps);alert('Saved');signaturePad.clear();document.getElementById('photoInput').value='';document.getElementById('signatureSection').classList.add('hidden');document.getElementById('customerPackages').innerHTML=''}
